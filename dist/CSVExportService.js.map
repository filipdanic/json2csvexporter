{"version":3,"file":"CSVExportService.js","sources":["../src/WriterService.js","../src/CSVExportService.js"],"sourcesContent":["/**\n * Provides an interface for mapping JS data types to a delimiter-separated value.\n * Creates a list of lists called rows and maps it to a Blob via toBlob().\n */\nexport default class WriterService {\n\n  /**\n   * Default constructors. Takes two optional params.\n   * @param  {string} delimiter - Delimiter character(s) to be used in the CSV.\n   * @param  {string} contentType - Type of file.\n   */\n  constructor(delimiter = ',', contentType = 'text/csv') {\n    this.delimiter = delimiter;\n    this.contentType = contentType;\n    this.rows = [[]];\n  }\n\n  /**\n   * Returns the current row\n   * @return {Array} - An array of values.\n   */\n  get currentRow() {\n    return this.rows[this.rows.length - 1];\n  }\n\n  /**\n   * Returns the input string\n   * @param  {string} string - The input string.\n   * @return {string} - A safe strings wrapped in quotes.\n   */\n  wrapWithQuotes(string) {\n    const safeString = string.replace(/\"/g, '\"\"');\n    return `\"${safeString}\"`;\n  }\n\n  /**\n   * @param {*} value\n   * @return {string}\n   */\n  sanitizeValue(value) {\n    if (\n      value === undefined ||\n      value === null ||\n      typeof value === 'function'\n    ) {\n      return '';\n    }\n    return String(value);\n  }\n\n  /**\n   * Pushes a new value into the current row.\n   * @param  {*} value - The value to push.\n   */\n  writeValue(value) {\n    const stringValue = this.sanitizeValue(value);\n    const needsQuotes = stringValue.indexOf(this.delimiter) !== -1 || /\"\\r\\n/.test(stringValue);\n    this.currentRow.push(needsQuotes ? this.wrapWithQuotes(stringValue) : stringValue);\n  }\n\n  /**\n   * Adds a en empty array to rows property. This maps to an empty line.\n   */\n  writeLine() {\n    this.rows.push([]);\n  }\n\n  /**\n   * Flatten rows to a String.\n   * @return {string} - A string representation of the rows..\n   */\n  toString() {\n    return this.rows.map(row => {\n      return row.join(this.delimiter);\n    }).reduce((content, row) => {\n      return `${content}\\r\\n${row}`;\n    });\n  }\n\n  /**\n   * Transform the rows into a Blob.\n   * @return {Object} - A representation of the rows in the form of\n   * a Blob. The returned Object is an instance of Blob, but typeof Object.\n   */\n  toBlob() {\n    return new Blob([this.toString()], {type: this.contentType});\n  }\n}\n","import WriterService from './WriterService';\n/**\n * Provides an ExportService that uses WriterService to mentain an in-memory representation of the CSV file.\n * Uses downloadCSV to map the [data] via the Writer to a Blob and initiate download which triggers the download of the actual file in the browser.\n * Provides static methods for Singleton-like usage.\n */\nexport default class CSVExportService {\n  /**\n   * Default constructor. Takes an optional options param.\n   * @param  {Object} options - Provides the configuration options.\n   */\n  constructor(options) {\n    this.options = options || {};\n  }\n\n  /**\n   * Shorthand for createCSV() with a pre-set writerType\n  */\n  createCSVBlob(data) {\n    return this.createCSV(data);\n  }\n\n  /**\n    * Shorthand for createCSV() with a pre-set writerType\n  */\n  dataToString(data) {\n    return this.createCSV(data, 'string');\n  }\n\n  /**\n   * Creates a Blob based on the provided data and configuration options.\n   * @param  {Array} data - An array of JSON objects that will be mapped to the Blob.\n   * @param  {String} writerType - ENUM for choosing the return type. Default to 'blo'\n   * @return {Object|String} - The Blob object (Is an instance of Blob, but typeof Object) or a String version of the CSV with newlines.\n   */\n  createCSV(data, writerType = 'blob') {\n    const {\n      columns: optionsColumns,\n      contentType: optionsContentType,\n      delimeter: optionsDelimeter, // delimeter is a common miss-spelling of “delimiter”\n      delimiter: optionsDelimiter,\n      formatters: optionsFormatters,\n      headers: optionsHeaders,\n      includeHeaders: optionsIncludeHeaders,\n    } = this.options || {};\n    const contentType = optionsContentType || 'text/csv';\n    const delimiter = optionsDelimeter || ',';\n    const formatters = optionsFormatters || {};\n    const getFormater = header => formatters[header] || (v => v);\n    const headerNames = optionsHeaders || {};\n    const headers = optionsColumns || Object.getOwnPropertyNames(data[0]);\n    const includeHeaders = optionsIncludeHeaders;\n    const writer = new WriterService(delimiter, contentType);\n\n    if (includeHeaders === undefined || includeHeaders) {\n      headers.forEach(header => writer.writeValue(headerNames[header] || header));\n      writer.writeLine();\n    }\n    data.forEach(row => {\n      headers.forEach(header => writer.writeValue(getFormater(header)(row[header])));\n      writer.writeLine();\n    });\n    return writerType === 'string' ? writer.toString() : writer.toBlob();\n  }\n  /**\n   * Triggers the download of the file.\n   * @param  {Object} blob - The blob to be downloaded.\n   * @param  {String} filename - Name of the file.\n   */\n  download(blob, filename) {\n    if (navigator.msSaveBlob) {\n      navigator.msSaveBlob(blob, filename);\n      return;\n    }\n    const link = document.createElement('A');\n    const url = URL.createObjectURL(blob);\n    link.href = url;\n    link.download = filename;\n    link.style.display = 'none';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  }\n\n  /**\n   * Creates and passes the blob and filename params to the download() method. In case of error, calls the onError callback (if provided) and prints a error mesage if devMode is enabled via options.\n   * @param  {Array} data - An array of objects to map and store.\n   */\n  downloadCSV(data) {\n    try {\n      const blob = this.createCSV(data, 'blob');\n      const filename = this.options.filename || `export-${new Date().getTime() / 1000 | 0}.csv`;\n      this.download(blob, filename);\n    } catch (err) {\n      if (this.options.devMode) {\n        console.error('Error downloading CSV. Send this log to the developers: \\n', err);\n      }\n      if (this.options.onError) {\n        this.options.onError(err);\n      }\n    }\n  }\n\n  /**\n   * Shorthand for constructor.\n   * @param  {Object} options\n   * @return {Object} - An instance of CSVExportService\n   */\n  static create(options) {\n    return new CSVExportService(options);\n  }\n\n  /**\n   * Shorthand for initialization and download() call.\n   * @param {Array} data - An array of objects to map and store.\n   * @param {Object} options\n   * @return {undefined}\n   */\n  static download(data, options = {}) {\n    return new CSVExportService(options).downloadCSV(data);\n  }\n}\n"],"names":["WriterService","delimiter","contentType","rows","string","safeString","replace","value","undefined","String","stringValue","sanitizeValue","needsQuotes","indexOf","test","currentRow","push","wrapWithQuotes","map","row","join","reduce","content","Blob","toString","type","length","CSVExportService","options","data","createCSV","writerType","optionsColumns","columns","optionsContentType","optionsDelimeter","delimeter","optionsDelimiter","optionsFormatters","formatters","optionsHeaders","headers","optionsIncludeHeaders","includeHeaders","getFormater","header","v","headerNames","Object","getOwnPropertyNames","writer","forEach","writeValue","writeLine","toBlob","blob","filename","navigator","msSaveBlob","link","document","createElement","url","URL","createObjectURL","href","download","style","display","body","appendChild","click","removeChild","Date","getTime","err","devMode","console","error","onError","downloadCSV"],"mappings":"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"}